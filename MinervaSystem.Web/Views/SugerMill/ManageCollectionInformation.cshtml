@using MinervaSystem.Base.Models
@{
    @Styles.Render("~/Content/kendo.office365")
    ViewBag.HeaderContent = ViewBag.HeaderContent ?? new HeaderContentModel("Supply Order",
        new BreadcrumbModel("Supply Order", new List<LinkModel>() { new LinkModel("/SupplyOrder", "Site Action") }));

}
@Html.Partial("_HeaderContentPartial", (HeaderContentModel)ViewBag.HeaderContent)

@Styles.Render("~/Content/datatables")


<link href="~/Content/telerik/kendo.common-material.min.css" rel="stylesheet" />
<link href="~/Content/telerik/kendo.rtl.min.css" rel="stylesheet" />
<link href="~/Content/telerik/kendo.material.min.css" rel="stylesheet" />
<link href="~/Content/telerik/kendo.material.mobile.min.css" rel="stylesheet" />
<style>
    .table > thead > tr > th {
        background: #605ca8;
        color: #fff;
    }

    .form-control {
        height: auto;
    }
    /*.k-header{background:#ccc;}*/
</style>

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">            
                <div class="box-header">
                    <div>
                       <label>Date: </label><label id="pTodaysDate" style="padding-left:10px"></label>
                        <button type="button" class="btn btn-primary" onclick="supplyorder.sentBulkSmsNotification();">Sent Notification</button>
                    </div>
                </div>
                <div class="box-body">
                    <table id="tableSupplyInformation" class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0">
                        <thead>
                            <tr>
                                <th width="5%">Code</th>
                                <th width="12%">Farmer</th>
                                <th width="10%">Mobile</th>
                                <th width="12%">Suger Mill</th>
                                <th width="10%">Amount to Collect</th>
                                <th width="10%">Actually Collected</th>
                                <th width="10%">Collection Date</th>
                                <th width="5%">Is Collected</th>
                                <th width="10%">Note</th>
                                <th>&nbsp;</th>
                                <th>&nbsp;</th>
                                <th>&nbsp;</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<div id="winViewItem" style="overflow:hidden;">
    <div style="margin:1px; overflow:hidden;">
        <div class="row">
            <label class="col-xs-3 col-form-label">Name:</label>
            <div class="col-sm-3">
                <p id="soFarmerName" class=""></p>
            </div>
        </div>
        <div class="row">
            <label class="col-xs-3 col-form-label">Suger Mill:</label>
            <div class="col-sm-7">
                <p id="soSugerMillName" class=""></p>
            </div>
        </div>
        <div class="row">
            <label class="col-xs-3 col-form-label">Plant/Ratoon:</label>
            <div class="col-sm-7">
                <p id="soPlantRatoon" class=""></p>
            </div>
        </div>
        <div class="row">
            <label class="col-xs-3 col-form-label">Land Area:</label>
            <div class="col-sm-7">
                <p id="soLandArea" class=""></p>
            </div>
        </div>
        <div class="row">
            <label class="col-xs-3 col-form-label">Estimated Amount:</label>
            <div class="col-sm-7">
                <p id="soTotalEstimatedAmount" class=""></p>
            </div>
        </div>
        <div class="form-group row">
            <label for="txtAmountoCollect" class="col-xs-3 col-form-label">Amount to Collect:</label>
            <div class="col-xs-3">
                <input type="text" class="form-control" id="txtAmountoCollect" placeholder="Amount to Collect">
            </div>
        </div>
        <div class="form-group row">
            <label for="txtActuallyCollected" class="col-xs-3 col-form-label">Actually Collected:</label>
            <div class="col-xs-3">
                <input type="text" class="form-control" id="txtActuallyCollected" placeholder="Actually Collected">
            </div>
        </div>
        <div class="form-group row">
            <label class="col-xs-3 col-form-label">Collection Date:</label>
            <div class="col-xs-7"><input type="text" class="form-control kendo-datetimepicker" id="txtCollectionDate" placeholder="Collection Date"></div>
        </div>
        <div class="form-group row">
            <label class="col-xs-3 col-form-label">Note:</label>
            <div class="col-xs-7"><textarea rows="4" cols="10" class="form-control" id="txtSoNote"></textarea></div>
        </div>
        <div class="form-group row">
            <label class="col-xs-3 col-form-label">Is Collected:</label>
            <div class="col-xs-7"><input type="checkbox" id="cbIsCollected" name="isCollected" value="IsCollected"></div>
        </div>
        <hr>
        <div class="modal-btn-toolbar" style="float:right;">
            <button type="button" id="btnSupplyOrderSubmit" value="Submit" class="btn btn-default" style="float:right"><i class="fa fa-check-square-o btn-save"></i> Submit</button>
            <button onclick="winViewItem.close()" class="btn btn-default" style="float:right"><i class="fa fa-ban btn-cancel"></i> Close</button>
        </div>
    </div>
</div>

<div id="winDeleteItem">
    <p>
        The supply order will be permanently deleted and cannot be recovered.<br />
        Are you sure you want to delete the item?
    </p>
    <div class="modal-btn-toolbar">
        <button onclick="supplyorder.deleteSupplyOrder()" class="btn btn-default"><i class="fa fa-close btn-delete"></i> Delete</button>
        <button onclick="winDeleteItem.close()" class="btn btn-default"><i class="fa fa-ban btn-cancel"></i> Cancel</button>
    </div>
</div>

@section Scripts
{
    @Scripts.Render("~/bundles/DataTables/Allbuttons")
    @Scripts.Render("~/bundles/kendo")

    <script type="text/javascript" language="javascript">
        var datatable;
        var winAddItem, winEditItem, winViewItem, winDeleteItem;
        var itemId = null;

        $(document).ready(function () {
            SetupSupplyOrdersDataTable();
            SetupPopupBoxes();
            var fullDate = new Date();
            var twoDigitMonth = fullDate.getMonth() + ""; if (twoDigitMonth.length == 1) twoDigitMonth = "0" + twoDigitMonth;
            var twoDigitDate = fullDate.getDate() + ""; if (twoDigitDate.length == 1) twoDigitDate = "0" + twoDigitDate;
            var currentDate = twoDigitDate + "/" + twoDigitMonth + "/" + fullDate.getFullYear(); console.log(currentDate);
            $('#pTodaysDate').html(currentDate);
        });
        function SetupSupplyOrdersDataTable() {
            if (datatable != null) {
                $('#tableSupplyInformation').empty();
            }
            datatable = $("#tableSupplyInformation").DataTable({
                bDestroy: true,
                ajax: {
                    url: '@Url.Action("GetAllCollectionInformations", "SugerMill")',
                    type: "GET",
                },
                columnDefs: [
                    { targets: 0, data: "Code" },
                    { targets: 1, data: "FarmerName", orderable: true },
                    { targets: 2, data: "MobileNo", orderable: false },
                    { targets: 3, data: "SugerMillName", orderable: false },
                    { targets: 4, data: "EstimatedAmount", orderable: false },
                    { targets: 5, data: "CollectedAmount", orderable: false },
                    { targets: 6, data: "CollectedAmount", render: function (data, type, row) { return FormatDateValue(ParseJsonDate(data), { "format": "dd-MM-yyyy" }) } },
                    { targets: 7, data: "IsCollected", orderable: false },
                    { targets: 8, data: "Note", orderable: false },
                    { targets: 9, data: null, orderable: false, class: "text-center view-control", render: function (data, type, row) { return "<a onclick='supplyorder.initSupplyOrder(this);'><i id='addHide' class='fa fa-bars'></i></a>"; } },
                    { targets: 10, data: null, orderable: false, class: "text-center edit-control", render: function (data, type, row) { return "<a href='@Url.Action("UpdateSupplyOrder", "SugerMill")/" + row.Id + "'><i class='fa fa-edit'></i></a>"; } },
                    { targets: 11, data: null, orderable: false, class: "text-center delete-control", render: function (data, type, row) { return "<a onclick='itemId=" + row.Id + ";winDeleteItem.center().open();'><i class='fa fa-remove'></i></a>"; } }],
                order: [[1, "asc"]],
                lengthChange: true,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]]
            });
            new $.fn.dataTable.Buttons(datatable, [
                                               {
                                                   extend: 'excel',
                                                   text: '<span class="fa fa-file-excel-o"></span> Excel',
                                                   exportOptions: {
                                                       modifier: {
                                                           search: 'applied',
                                                           order: 'applied'
                                                       }
                                                   }
                                               },
                                               {
                                                   extend: 'pdf',
                                                   text: '<span class="fa fa-file-pdf-o"></span> PDF',
                                                   exportOptions: {
                                                       modifier: {
                                                           search: 'applied',
                                                           order: 'applied'
                                                       }
                                                   }
                                               },
                                                  {
                                                      extend: 'print',
                                                      text: '<span class="fa fa-print"></span> Print',
                                                      exportOptions: {
                                                          modifier: {
                                                              search: 'applied',
                                                              order: 'applied'
                                                          }
                                                      }
                                                  }
            ]);

            datatable.buttons().container().appendTo($('.col-sm-6:eq(0)', datatable.table().container()));
            datatable.buttons().container().appendTo('#tableSupplyInformation_filter');
        }

        function SetupPopupBoxes() {
            winViewItem = $("#winViewItem").kendoWindow({
                minWidth: 600,
                modal: true,
                visible: false,
                draggable: false,
                title: "Supply Order",
                open: function (obj) {
                },
                close: function () {
                    itemId = null;
                    $("#winViewItem div[id^='view-']").text("");
                }
            }).data("kendoWindow");
            winDeleteItem = $("#winDeleteItem").kendoWindow({
                minWidth: 500,
                modal: true,
                visible: false,
                draggable: false,
                title: "Delete Supply Order",
                close: function () { itemId = null; }
            }).data("kendoWindow");
        }

        var supplyorder = {
            initSupplyOrder: function (obj) {
                var tr = $(obj).closest("tr");
                var supplyOrderData = datatable.row(tr).data();
                supplyorder.clearSupplyOrderData();
                supplyorder.loadSupplyOrderPopup(supplyOrderData);
                $('#btnSupplyOrderSubmit').off('click').click(function () {
                    supplyorder.editSupplyOrder(supplyOrderData);
                });
                winViewItem.center().open();
            },
            loadSupplyOrderPopup: function (supplyOrderData) {
                $("#soFarmerName").text(supplyOrderData.FarmerName);
                $("#soSugerMillName").text(supplyOrderData.SugerMillName);
                $("#soPlantRatoon").text(supplyOrderData.PlantRatoon);
                $("#soLandArea").text(supplyOrderData.LandArea);
                $("#soTotalEstimatedAmount").text(supplyOrderData.EstimatedAmount);
                $("#txtAmountoCollect").val(supplyOrderData.AmounttoCollect);
                $("#txtActuallyCollected").val(supplyOrderData.CollectedAmount);
                $("#txtCollectionDate").val(FormatDateValue(ParseJsonDate(supplyOrderData.CollectionDate), { "format": "dd/MM/yyyy hh:mm tt" }));
                $('#cbIsCollected').prop('checked', supplyOrderData.IsCollected);
                $("#txtSoNote").val(supplyOrderData.Note);
            },
            editSupplyOrder: function (supplyOrderData) {
                var supplyOrderObj = supplyorder.getSupplyOrderData(supplyOrderData);
                if (supplyorder.validateSupplyOrder(supplyOrderObj)) {
                    $.ajax({
                        url: '@Url.Action("UpdateSupplyOrder", "SugerMill")',
                        type: "Post",
                        //dataType: 'json',
                        data: supplyOrderObj,
                        success: function (response) {
                            winViewItem.close();
                            supplyorder.sendSMS();
                        }, error: function (response) {

                        }
                    });
                } else alert("Please Enter Required Information.");
            },
            validateSupplyOrder: function (supplyOrderData) {
                var msg = "";
                if (!supplyOrderData.EstimatedAmount || !supplyOrderData.CollectionDate) return false;
                else return true;
            },
            getSupplyOrderData: function (supplyOrderData) {
                var supplyOrderObj = new Object();
                supplyOrderObj.Id = supplyOrderData.Id;
                supplyOrderObj.SugerMillId = supplyOrderData.SugerMillId;
                supplyOrderObj.SupplyInformationId = supplyOrderData.Id;
                supplyOrderObj.MobileNo = supplyOrderData.MobileNo;
                var collectedAmount = parseFloat($('#txtAmountoCollect').val());
                supplyOrderObj.EstimatedAmount = isNaN(collectedAmount) ? null : collectedAmount;
                var actuallyCollected = parseFloat($('#txtActuallyCollected').val());
                supplyOrderObj.CollectedAmount = isNaN(actuallyCollected) ? null : actuallyCollected;
                supplyOrderObj.CollectionDate = !$("#txtCollectionDate").val() ? null : $("#txtCollectionDate").val();
                supplyOrderObj.Note = !$("#txtSoNote").val() ? null : $("#txtSoNote").val();
                supplyOrderObj.IsCollected = $('#cbIsCollected').prop('checked');
                return supplyOrderObj;
            },
            sendSMS: function (response) {
                var smsRequest = supplyorder.getSMSrequest(response);
                $.ajax({
                    url: response.url,
                    type: "POST",
                    data: JSON.stringify(supplyOrderObj),
                    headers: { "Authorization": response.authorization },
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        winViewItem.close();
                        alert("You will get a quick SMS");
                    }, error: function (response) {
                        console.log(response);
                    }
                });
            },
            getSMSrequest: function (response) {
                var smsRequest = new Object();
                smsRequest.from = response.from;
                smsRequest.to = response.mobileNo;
                smsRequest.text = response.responseMsg;
                return smsRequest;
            },
            clearSupplyOrderData: function () {
                $("#soFarmerName").text('');
                $("#soSugerMillName").text('');
                $("#soPlantRatoon").text('');
                $("#soLandArea").text('');
                $("#soTotalEstimatedAmount").text('');
                $("#txtAmountoCollect").val('');
                $("#txtActuallyCollected").val('');
                $("#txtCollectionDate").val('');
                $('#cbIsCollected').prop('checked', false);
                $("#txtSoNote").val('');
            },
            deleteSupplyOrder: function () {
                if (itemId != null) {
                    $.ajax({
                        url: '@Url.Action("DeleteSupplyOrder", "SugerMill")', type: "Post",
                        data: { supplyOrderId: itemId },
                        async: false, cache: false,
                        success: function (response) {
                            winDeleteItem.close();
                            datatable.ajax.reload();
                            return true;
                        }, error: function () { return false; }
                    });
                }
            },
            sentBulkSmsNotification: function () {

            }
        }
    </script>
}
